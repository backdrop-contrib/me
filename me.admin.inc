<?php
/**
 * @file
 *
 * Administrative page for the Me Aliases module.
 */

/**
 * Form callback for the admin settings form.
 */
function me_admin_settings_form($form, &$form_state) {
  $form = array();
  $form['#config'] = 'me.settings';

  $form['alias'] = array(
    '#type' => 'textfield',
    '#title' => t("'Me' Alias"),
    '#description' => t("The alias to use to represent the current user's uid. !link.",
      array('!link' => theme('token_tree_link'))),
    '#default_value' => config_get('me.settings', 'alias'),
    '#required' => TRUE,
  );

  $form['case_insensitive'] = array(
    '#type' => 'checkbox',
    '#title' => t('Case Insensitive Alias Checking'),
    '#description' => t('When checked, "Me" will be matched the same as "me", "ME", and "mE".'),
    '#default_value' => config_get('me.settings', 'case_insensitive'),
  );

  $form['rewrite_link'] = array(
    '#type' => 'checkbox',
    '#title' => t('Rewrite links generated by the Backdrop menu system'),
    '#description' => t('When checked, links output by the Backdrop menu system will replace uid with the me alias.'),
    '#default_value' => config_get('me.settings', 'rewrite_link'),
  );

  $form['user_override'] = array(
    '#type' => 'checkbox',
    '#title' => t('Allow users to turn off me for their account'),
    '#default_value' => config_get('me.settings', 'user_override'),
  );

  $form['redirect'] = array(
    '#type' => 'checkbox',
    '#title' => t('Redirect to uid'),
    '#description' => t('When checked, perform a redirect so the users uid is shown in the address bar instead of the me alias.'),
    '#default_value' => config_get('me.settings', 'redirect'),
  );

  $form['redirect_anonymous'] = array(
    '#type' => 'textfield',
    '#title' => t('Redirect anonymous users'),
    '#description' => t('When this is non-empty, anonymous users will be redirected to the specified Backdrop path.'),
    '#default_value' => config_get('me.settings', 'redirect_anonymous'),
  );

  $access = user_access('use PHP for me alias paths');
  $path_rule = config_get('me.settings', 'path_rule');
  $paths = config_get('me.settings', 'paths');

  if ($path_rule == ME_PATH_PHP && !$access) {
    $form['me_paths_settings'] = array();
    $form['me_paths_settings']['path_rule'] = array(
      '#type' => 'value',
      '#value' => $path_rule,
    );
    $form['me_paths_settings']['paths'] = array(
      '#type' => 'value',
      '#value' => $paths,
    );
  }
  else {
    $options = array(
      ME_PATH_EXCLUDE => t('Use me alias on every path except the listed paths.'),
      ME_PATH_INCLUDE => t('Use me alias only on the listed paths.'),
    );
    $description = t("Enter one path per line as Backdrop paths. The '*' character is a wildcard. Example paths are %blog for the blog page and %blog-wildcard for every personal blog. %front is the front page.", array('%blog' => 'blog', '%blog-wildcard' => 'blog/*', '%front' => '<front>'));

    if ($access) {
      $options[ME_PATH_PHP] = t('Use me alias if the following PHP code returns <code>TRUE</code> (PHP-mode, experts only).');
      $description .= ' ' . t('If the PHP-mode is chosen, enter PHP code between %php. Note that executing incorrect PHP-code can break your Backdrop site.', array('%php' => '<?php ?>'));
    }
    $form['me_paths_settings']['path_rule'] = array(
      '#type' => 'radios',
      '#title' => t('Use me alias on specific paths'),
      '#options' => $options,
      '#default_value' => $path_rule,
    );
    $form['me_paths_settings']['paths'] = array(
      '#type' => 'textarea',
      '#title' => t('Paths'),
      '#default_value' => $paths,
      '#description' => $description . t('<p>NOTE: This option simply ensures that the browser address bar for these paths have the uid and not me. The me alias will still work for these paths. It will have no effect on specific uids in paths, but if the path includes the me alias, then me will be affected for those paths. This will only affect paths that me can already handle. It will not allow me to work for unknown paths.</p>'),
    );
  }

  $form['#validate'] = array('me_admin_settings_form_validate');

  $form = system_settings_form($form);

  // Quite a few options only have an affect on theme and menu rebuilds. We just do them here
  // to make sure the options have an instant effect.
  $form['#submit'][] = 'menu_rebuild';
  $form['#submit'][] = 'backdrop_theme_rebuild';

  return $form;
}

/**
 * Validation callback for me_admin_settings_form.
 */
function me_admin_settings_form_validate($form, &$form_state) {
  // If the token module is installed, we need to also allow a list of tokens
  // that are allowed to match against. We include all global tokens here, even though
  // some of them don't really make sense, but that is up to the end user.
  $token_list = array();
  //$token_list = array_map(create_function('$n', 'return "[$n]";'), array_keys(array_pop(token_info())));
  $tk_types = token_get_global_token_types();
  $options = array(
    'flat' => TRUE,
    'restricted' => FALSE,
    'depth' => 4,
  );
  foreach ($tk_types as $type) {
    $tree = token_build_tree($type, $options);
    $token_list = array_merge($token_list, array_keys($tree));
  }
  if (preg_match('/[^a-zA-Z\:]/', $form_state['values']['alias']) &&
    !in_array($form_state['values']['alias'], $token_list)) {
    if (!empty($token_list)) {
      $message = t('The alias can only contain characters from a-z and A-Z, or one of the tokens specified in the "Replacement patterns for me alias" section.');
    }
    else {
      $message = t('The alias can only contain characters from a-z and A-Z.');
    }
    form_set_error('alias', $message);
  }
}
